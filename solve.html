<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/js/bootstrap-select.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/css/bootstrap-select.min.css" rel="stylesheet"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />

<link rel="stylesheet" type="text/css" href="style.css">

<!-- <script src="bundle.js"></script> -->
<script language="javascript" type="text/javascript" src="web3.min.js"></script>
<script src="abi.js"></script>
<script src="node_modules/js-sha3/src/sha3.js"></script>

<!-- FONTS -->
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="https://fonts.googleapis.com/css?family=Bree+Serif|Muli|Nanum+Gothic|Open+Sans+Condensed:300|Open+Sans:300,400" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NP-Pay</title>
</head>
<body>
  <script>
  // keccak256 = require('js-sha3').keccak256;
  var nppay;
  var userAccount;

  function startApp(){
    // var web3 = new Web3( new Web3.providers.HttpProvider("http://127.0.0.1:7545"));
    var nppayAddr = '0x43Ee8229Ed1BEe11706b806812447854FAc3b287';
    // nppay = web3.eth.contract(abi).at(nppayAddr);
    nppay = new web3js.eth.Contract(abi, nppayAddr);
    // userAccount = web3.eth.accounts[0];

    userAccount  = "0x174f58A431A8D2Be1E1e58265bb63801caAEddcb";
    // nppay = new web3js.eth.Contract(abi, nppayAddr);
    // console.log(nppay);
    // nppay = nppay.options.address('0x43Ee8229Ed1BEe11706b806812447854FAc3b287');
    console.log(nppay);

    // var accountInterval = setInterval(function() {
    //   if (web3.eth.accounts[0] !== userAccount) {
    //     userAccount = web3.eth.accounts[0];
    //   }
    // }, 100);
  }

  function wait(ms){
   var start = new Date().getTime();
   var end = start;
   while(end < start + ms) {
     end = new Date().getTime();
  }
}

  function issueSolutionHash() {
    //Get fields
    var pId = document.getElementById("pid").value;
    var solString = document.getElementById("solstring").value;

    //hash
    var hash = keccak256(solString);
    var hash_bytes = web3.fromAscii(hash);

    var hashId;
    nppay.methods.proposeSATSolutionHash(pId, hash_bytes)
    .send({from: userAccount, value: web3js.utils.toWei("1", "ether")})
      .on("receipt", function(receipt){
        console.log(receipt);
        // proposeSATSolution(pId, hashId, solString);
      }).on("error", function(error){
        console.log(error);
      })
      .then(function(id) {
        hashId = id;
      })
  }

  function issueSolution(pId, hashId, solString){
    nppay.methods.proposeSATSolution(pId, hashId, solString)
    .send({from: userAccount, value: web3js.utils.toWei("2", "ether")})
      .on("receipt", function(receipt){
        console.log(receipt);
      }).on("error", function(error){
        console.log(error);
      })
      .then(function(solID) {
        //Do something with solID
      })
  }

  window.addEventListener('load', function() {

    // Checking if Web3 has been injected by the browser (Mist/MetaMask)
    if (typeof web3 !== 'undefined') {
      // Use Mist/MetaMask's provider
      console.log("We have Web3.js")
      web3js = new Web3(web3.currentProvider);
    }
    else {
      // Handle the case where the user doesn't have web3. Probably
      // show them a message telling them to install Metamask in
      // order to use our app.
      console.log("We don't have Web3.js!!")
      web3js = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:7545"));
    }

    // Now you can start your app & access web3js freely:
    startApp()
    // userAccount = web3.eth.accounts[0];

  })
  </script>

  <nav class="navbar navbar-default navbar-fixed-top navbar-light"
  style="background-color: #f7931a;border:none;">
    <div class="container-fluid">
      <div class="navbar-header navbar-light" style="background-color: #f7931a;">
        <a class="navbar-brand" href="index.html">
          <img alt="Brand" src="img/icon.png">
        </a>
        <p class="navbar-text" id ="navbar-title" style="font-weight:900;color:white">NP-Pay</p>
      </div>
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="login.html" class="navbar-brand" id ="navbar-title">Login
          </a>
        </li>
      </ul>
    </div>
  </nav>

      <div id="container">

        <!-- HEADER TEXT -->
        <div class="headerDiv" id="div-border">
        <h1 id="h1-title">
          Problems to Solve
        </h1>
      </br>
      <h3 id="h3-title">Issued NP Problems</h3></br>

  </div>

  <div class="innerDiv">
      <h2>Please Provide Solution Information</h2></br>
      <form class="form-horizontal" action="" onsubmit="return issueSolutionHash()">
        <div class="col-sm-10">
          <input type="text" class="form-control" id="solstring" placeholder="Enter SAT Solution String" name="solstring">
        </div>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="pid" placeholder="Enter Problem ID" name="pid">
        </div>
        <div class="form-group">
          <div class="col-sm-offset-2 col-sm-10">
            <button type="submit" class="btn btn-default">Submit</button>
          </div>
      </form>
    </div>
  </div>

</body>
</html>
